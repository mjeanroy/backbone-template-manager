!function(e,t){if("function"==typeof define&&define.amd)define("BackboneTemplateManager",["exports","backbone","underscore"],t);else if("undefined"!=typeof exports)t(exports,require("backbone"),require("underscore"));else{var n={exports:{}};t(n.exports,e.Backbone,e._),e.BackboneTemplateManager=n.exports}}(this,function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}e.__esModule=!0,e.TemplateView=e.overrideTemplateManager=e.templateManager=e.overrideCompile=e.compile=e.RemoteTemplateManager=e.DomTemplateManager=undefined;var i=r(t),o=r(n),s=o["default"].noop,a=o["default"].has,u=o["default"].keys,c=o["default"].after,l=o["default"].isNull,f=o["default"].isUndefined,d=o["default"].isString,h=o["default"].isNumber,m=o["default"].isArray,p=o["default"].isObject,g=o["default"].isBoolean,_=o["default"].defaults,v=o["default"].isEmpty,T=o["default"].result,x=o["default"].every,M=o["default"].forEach,R=o["default"].clone,w=function(e,t){return f(e)?t:e},S=function(e){return e&&d(e)?String.prototype.trim?String.prototype.trim.call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""):e},b=function(e){return l(e)||f(e)?String(e):h(e)||d(e)||g(e)?e.toString():JSON.stringify(e)},E=function(e){return e[u(e)[0]]},F=function(e){this.options=e||{},this.initialize(this.options)};F.prototype={initialize:function(e){},fetch:function(e,t){var n=this,r=t||{},i=void 0,o=void 0;if(d(e))o=!0,i=[e];else{if(!m(e)||v(e)||!x(e,d))throw new Error("Templates must be a string or an array of string, found: "+b(e));o=!1,i=e}var a=r.success||s,u=r.error||s,l=r.done||s,f=c(i.length,function(e){var t=void 0,n=void 0;o?(t=E(e.success),n=E(e.errors)):(t=e.success,n=e.errors),v(n)?a(t):u(n),l(t,n),a=u=l=null}),h={success:{},errors:{}};M(i,function(e){n._doFetch(e,{success:function(t){h.success[e]=t,f(h)},error:function(t){h.errors[e]=t,f(h)}})})},clear:function(){},_doFetch:function(e,t){throw new Error('Method "doFetch" should be implemented')}},F.extend=i["default"].View.extend;var y=function(e){return'[data-template-id="'+e+'"]'},B=F.extend({initialize:function(e){this.selector=w(e.selector,y),this._cache={}},clear:function(){this._cache={}},_doFetch:function(e,t){var n=this;setTimeout(function(){var r=t.success,o=t.error,s=n._cache;if(a(s,e))r(s[e]);else{var u=n.selector(e),c=i["default"].$(u);v(c)||0===c.length?o({data:"Cannot find template: "+e}):c.length>1?o({data:"Found multiple templates for selector: "+u}):(s[e]=S(c.html()),r(s[e]))}})}}),J=function(e,t,n){var r=e.charAt(0),i=e.length>1?e.charAt(e.length-1):"",o=t.charAt(t.length-1),s=n.charAt(0),a=e;return"/"===r&&"/"===o?a=e.slice(1):"/"!==r&&"/"!==o&&(a="/"+e),"/"===i&&"/"===s&&(a=a.slice(0,a.length-1)),""+t+a+n},A=F.extend({initialize:function(e){this._prefix=w(T(e,"prefix"),"/templates/"),this._suffix=w(T(e,"suffix"),".template.html"),this._method=e.method||"GET",this._cache={};var t=e.JST;if(t)if(d(t))this._cache=R(window[t]||{});else if(g(t))this._cache=R(window.JST||{});else{if(!p(t)||m(t))throw new Error("Cannot infer JST variables from: "+b(t));this._cache=R(t)}},clear:function(){this._cache={}},_doFetch:function(e,t){var n=t.success,r=t.error,o=this._cache;if(!a(o,e)||l(o[e])){var s=this._prefix||"",u=this._suffix||"",c=this._method,f=J(e,s,u);o[e]=i["default"].ajax({url:f,method:c})}var h=o[e];if(d(h))setTimeout(function(){n(h)});else{o[e].then(function(t){o[e]=t,n(t)},function(t){o[e]=null,r({status:t.status,message:t.responseText})})}}}),N=function(e){return o["default"].template(e)},k=function(e){return N(e)},O=new A,z=function(){return O},C=i["default"].View.extend({templates:function(){return null},templateManager:function(){return z()},compile:function(e){return k(e)},toJSON:function(e){var t={},n=_(e||{},{view:!0});return this.model&&(t.model=this.model.toJSON(n)),this.collection&&(t.collection=this.collection.toJSON(n)),t},render:function(){var e=this,t=T(this,"templates");if(!v(t))return this._triggerBeforeRender(),T(this,"templateManager").fetch(t,{success:function(n){e._renderTemplates(t,n),e._triggerRenderSuccess()},error:function(t){e._triggerRenderError(t)}}),this},onBeforeRender:function(){},onRender:function(){},onRenderError:function(){},onRendered:function(e){},_triggerBeforeRender:function(){this.trigger("render:loading"),this.onBeforeRender()},_triggerRenderSuccess:function(){this.trigger("render:success"),this.onRender(),this.onRendered()},_triggerRenderError:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.trigger("render:error"),this.onRenderError(),this.onRendered(e)},_renderTemplates:function(e,t){var n=m(e)?t[0]:t,r=m(t)?t:null,i=this._toHTML(n,r);return this._setHtml(i),this},_toHTML:function(e,t){return this.compile(e)(this.toJSON(),t)},_setHtml:function(e){return this.$el.html(e),this}});e.DomTemplateManager=B,e.RemoteTemplateManager=A,e.compile=k,e.overrideCompile=function(e){N=e},e.templateManager=z,e.overrideTemplateManager=function(e){O.clear(),O=e},e.TemplateView=C});