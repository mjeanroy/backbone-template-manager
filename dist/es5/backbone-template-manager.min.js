!function(e,t){if("function"==typeof define&&define.amd)define("BackboneTemplateManager",["exports","backbone","underscore"],t);else if("undefined"!=typeof exports)t(exports,require("backbone"),require("underscore"));else{var r={exports:{}};t(r.exports,e.Backbone,e._),e.BackboneTemplateManager=r.exports}}(this,function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{"default":e}}e.__esModule=!0,e.VIEW_RENDER_DONE=e.VIEW_RENDER_ERROR=e.VIEW_RENDER_SUCCESS=e.VIEW_RENDER_LOADING=e.TemplateView=e.overrideTemplateManager=e.templateManager=e.overrideCompile=e.compile=e.RemoteTemplateManager=e.DomTemplateManager=undefined;var i=n(t),o=n(r),s=o["default"].noop,a=o["default"].has,u=o["default"].keys,c=o["default"].after,l=o["default"].isNull,f=o["default"].isUndefined,d=o["default"].isString,h=o["default"].isNumber,m=o["default"].isArray,g=o["default"].isObject,p=o["default"].isBoolean,_=o["default"].defaults,E=o["default"].isEmpty,R=o["default"].result,v=o["default"].every,T=o["default"].forEach,x=o["default"].clone,S=function(e,t){return f(e)?t:e},N=function(e){return e&&d(e)?String.prototype.trim?String.prototype.trim.call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""):e},D=function(e){return l(e)||f(e)?String(e):h(e)||d(e)||p(e)?e.toString():JSON.stringify(e)},M=function(e){return e[u(e)[0]]},w=function(e){this.options=e||{},this.initialize(this.options)};w.prototype={initialize:function(e){},fetch:function(e,t){var r=this,n=t||{},i=void 0,o=void 0;if(d(e))o=!0,i=[e];else{if(!m(e)||E(e)||!v(e,d))throw new Error("Templates must be a string or an array of string, found: "+D(e));o=!1,i=e}var a=n.success||s,u=n.error||s,l=n.done||s,f=c(i.length,function(e){var t=void 0,r=void 0;o?(t=M(e.success),r=M(e.errors)):(t=e.success,r=e.errors),E(r)?a(t):u(r),l(t,r),a=u=l=null}),h={success:{},errors:{}};T(i,function(e){r._doFetch(e,{success:function(t){h.success[e]=t,f(h)},error:function(t){h.errors[e]=t,f(h)}})})},clear:function(){},_doFetch:function(e,t){throw new Error('Method "doFetch" should be implemented')}},w.extend=i["default"].View.extend;var b=function(e){return'[data-template-id="'+e+'"]'},F=w.extend({initialize:function(e){this.selector=S(e.selector,b),this._cache={}},clear:function(){this._cache={}},_doFetch:function(e,t){var r=this;setTimeout(function(){var n=t.success,o=t.error,s=r._cache;if(a(s,e))n(s[e]);else{var u=r.selector(e),c=i["default"].$(u);E(c)||0===c.length?o({data:"Cannot find template: "+e}):c.length>1?o({data:"Found multiple templates for selector: "+u}):(s[e]=N(c.html()),n(s[e]))}})}}),O=function(e,t,r){var n=e.charAt(0),i=e.length>1?e.charAt(e.length-1):"",o=t.charAt(t.length-1),s=r.charAt(0),a=e;return"/"===n&&"/"===o?a=e.slice(1):"/"!==n&&"/"!==o&&(a="/"+e),"/"===i&&"/"===s&&(a=a.slice(0,a.length-1)),""+t+a+r},V=w.extend({initialize:function(e){this._prefix=S(R(e,"prefix"),"/templates/"),this._suffix=S(R(e,"suffix"),".template.html"),this._method=e.method||"GET",this._cache={};var t=e.JST;if(t)if(d(t))this._cache=x(window[t]||{});else if(p(t))this._cache=x(window.JST||{});else{if(!g(t)||m(t))throw new Error("Cannot infer JST variables from: "+D(t));this._cache=x(t)}},clear:function(){this._cache={}},_doFetch:function(e,t){var r=t.success,n=t.error,o=this._cache;if(!a(o,e)||l(o[e])){var s=this._prefix||"",u=this._suffix||"",c=this._method,f=O(e,s,u);o[e]=i["default"].ajax({url:f,method:c})}var h=o[e];if(d(h))setTimeout(function(){r(h)});else{o[e].then(function(t){o[e]=t,r(t)},function(t){o[e]=null,n({status:t.status,message:t.responseText})})}}}),y=function(e){return o["default"].template(e)},I=function(e){return y(e)},A=new V,B=function(){return A},C=i["default"].View.extend({templates:function(){return null},templateManager:function(){return B()},compile:function(e){return I(e)},toJSON:function(e){var t={},r=_(e||{},{view:!0});return this.model&&(t.model=this.model.toJSON(r)),this.collection&&(t.collection=this.collection.toJSON(r)),t},render:function(){var e=this,t=R(this,"templates");if(!E(t))return this._triggerBeforeRender(),R(this,"templateManager").fetch(t,{success:function(r){e._renderTemplates(t,r),e._triggerRenderSuccess()},error:function(t){e._triggerRenderError(t)}}),this},onBeforeRender:function(){},onRender:function(){},onRenderError:function(){},onRendered:function(e){},_triggerBeforeRender:function(){this.trigger("render:loading"),this.onBeforeRender()},_triggerRenderSuccess:function(){this.trigger("render:success"),this.onRender(),this._triggerRenderDone()},_triggerRenderError:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.trigger("render:error",e),this.onRenderError(),this._triggerRenderDone(e)},_triggerRenderDone:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.trigger("render:done",e),this.onRendered(e)},_renderTemplates:function(e,t){var r=m(e)?t[0]:t,n=m(t)?t:null,i=this._toHTML(r,n);return this._setHtml(i),this},_toHTML:function(e,t){return this.compile(e)(this.toJSON(),t)},_setHtml:function(e){return this.$el.html(e),this}});e.DomTemplateManager=F,e.RemoteTemplateManager=V,e.compile=I,e.overrideCompile=function(e){y=e},e.templateManager=B,e.overrideTemplateManager=function(e){A.clear(),A=e},e.TemplateView=C,e.VIEW_RENDER_LOADING="render:loading",e.VIEW_RENDER_SUCCESS="render:success",e.VIEW_RENDER_ERROR="render:error",e.VIEW_RENDER_DONE="render:done"});