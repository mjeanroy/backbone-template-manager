!function(e,t){if("function"==typeof define&&define.amd)define("BackboneTemplateManager",["exports","backbone","underscore"],t);else if("undefined"!=typeof exports)t(exports,require("backbone"),require("underscore"));else{var r={exports:{}};t(r.exports,e.Backbone,e._),e.BackboneTemplateManager=r.exports}}(this,function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0,e.TemplateView=e.overrideTemplateManager=e.templateManager=e.overrideCompile=e.compile=e.RemoteTemplateManager=e.DomTemplateManager=void 0;var s=n(t),u=n(r),c=u["default"].noop,l=u["default"].has,f=u["default"].keys,p=u["default"].after,h=u["default"].isNull,d=u["default"].isUndefined,m=u["default"].isString,y=u["default"].isNumber,g=u["default"].isArray,v=u["default"].isObject,_=u["default"].isBoolean,T=u["default"].defaults,w=u["default"].isEmpty,b=u["default"].result,x=u["default"].every,M=u["default"].forEach,S=u["default"].clone,O=function(e,t){return d(e)?t:e},E=function(e){return h(e)||d(e)?String(e):y(e)||m(e)||_(e)?e.toString():JSON.stringify(e)},J=function(e){return e[f(e)[0]]},N=function(){function e(t){a(this,e),this.options=t||{},this.initialize(this.options)}return e.prototype.initialize=function(e){},e.prototype.fetch=function(e,t){var r=this,n=t||{},o=void 0,i=void 0;if(m(e))i=!0,o=[e];else{if(!g(e)||w(e)||!x(e,m))throw new Error("Templates must be a string or an array of string, found: "+E(e));i=!1,o=e}var a=n.success||c,s=n.error||c,u=n.done||c,l=p(o.length,function(e){var t=void 0,r=void 0;i?(t=J(e.success),r=J(e.errors)):(t=e.success,r=e.errors),w(r)?a(t):s(r),u(t,r),a=s=u=null}),f={success:{},errors:{}};M(o,function(e){r._doFetch(e,{success:function(t){f.success[e]=t,l(f)},error:function(t){f.errors[e]=t,l(f)}})})},e.prototype.clear=function(){},e.prototype._doFetch=function(e,t){throw new Error('Method "doFetch" should be implemented')},e}(),j=function(e){return'[data-template-id="'+e+'"]'},k=function(e){function t(){return a(this,t),o(this,e.apply(this,arguments))}return i(t,e),t.prototype.initialize=function(e){this.selector=O(e.selector,j),this._cache={}},t.prototype.clear=function(){this._cache={}},t.prototype._doFetch=function(e,t){var r=this;setTimeout(function(){var n=t.success,o=t.error,i=r._cache;if(l(i,e))return void n(i[e]);var a=r.selector(e),u=s["default"].$(a);w(u)||0===u.length?o({data:"Cannot find template: "+e}):u.length>1?o({data:"Found multiple templates for selector: "+a}):(i[e]=u.html(),n(i[e]))})},t}(N),F="/",A="/templates/",C=".template.html",z=function(e,t,r){var n=e.charAt(0),o=e.length>1?e.charAt(e.length-1):"",i=t.charAt(t.length-1),a=r.charAt(0),s=e;return n===F&&i===F?s=e.slice(1):n!==F&&i!==F&&(s="/"+e),o===F&&a===F&&(s=s.slice(0,s.length-1)),""+t+s+r},B=function(e){function t(){return a(this,t),o(this,e.apply(this,arguments))}return i(t,e),t.prototype.initialize=function(e){this._prefix=O(b(e,"prefix"),A),this._suffix=O(b(e,"suffix"),C),this._method=e.method||"GET",this._cache={};var t=e.JST;if(t)if(m(t))this._cache=S(window[t]||{});else if(_(t))this._cache=S(window.JST||{});else{if(!v(t)||g(t))throw new Error("Cannot infer JST variables from: "+E(t));this._cache=S(t)}},t.prototype.clear=function(){this._cache={}},t.prototype._doFetch=function(e,t){var r=t.success,n=t.error,o=this._cache;if(!l(o,e)||h(o[e])){var i=this._prefix||"",a=this._suffix||"",u=this._method,c=z(e,i,a);o[e]=s["default"].ajax({url:c,method:u})}var f=o[e];if(m(f))return void setTimeout(function(){r(f)});var p=function(t){o[e]=t,r(t)},d=function(t){o[e]=null,n({status:t.status,message:t.responseText})};o[e].then(p,d)},t}(N),H=function(e){return u["default"].template(e)},V=function(e){return H(e)},R=function(e){H=e},q=new B,D=function(){return q},L=function(e){q.clear(),q=e},P="render",$=function(e){function t(){return a(this,t),o(this,e.apply(this,arguments))}return i(t,e),t.prototype.templates=function(){return null},t.prototype.templateManager=function(){return D()},t.prototype.compile=function(e){return V(e)},t.prototype.toJSON=function(e){var t={},r=T(e||{},{view:!0});return this.model&&(t.model=this.model.toJSON(r)),this.collection&&(t.collection=this.collection.toJSON(r)),t},t.prototype.render=function(){var e=this,t=b(this,"templates");if(!w(t)){this.trigger(P+":loading");var r=b(this,"templateManager");return r.fetch(t,{success:function(r){e._renderTemplates(t,r),e.trigger(P+":success")},error:function(){e.trigger(P+":error")}}),this}},t.prototype._renderTemplates=function(e,t){var r=g(e)?t[0]:t,n=g(t)?t:null,o=this._toHTML(r,n);return this._setHtml(o),this},t.prototype._toHTML=function(e,t){var r=this.compile(e);return r(this.toJSON(),t)},t.prototype._setHtml=function(e){return this.$el.html(e),this},t}(s["default"].View);$.extend=s["default"].View.extend,e.DomTemplateManager=k,e.RemoteTemplateManager=B,e.compile=V,e.overrideCompile=R,e.templateManager=D,e.overrideTemplateManager=L,e.TemplateView=$});