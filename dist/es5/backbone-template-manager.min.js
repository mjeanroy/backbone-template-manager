!function(e,t){if("function"==typeof define&&define.amd)define("BackboneTemplateManager",["exports","backbone","underscore"],t);else if("undefined"!=typeof exports)t(exports,require("backbone"),require("underscore"));else{var n={exports:{}};t(n.exports,e.Backbone,e._),e.BackboneTemplateManager=n.exports}}(this,function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}e.__esModule=!0,e.VIEW_RENDER_DONE=e.VIEW_RENDER_ERROR=e.VIEW_RENDER_SUCCESS=e.VIEW_RENDER_LOADING=e.TemplateView=e.TemplateViewMixin=e.overrideTemplateManager=e.templateManager=e.overrideCompile=e.compile=e.RemoteTemplateManager=e.DomTemplateManager=undefined;var i=r(t),o=r(n),s=o["default"].noop,a=o["default"].has,u=o["default"].keys,c=o["default"].after,l=o["default"].isNull,f=o["default"].isUndefined,d=o["default"].isString,h=o["default"].isNumber,p=o["default"].isArray,m=o["default"].isObject,g=o["default"].isBoolean,_=o["default"].defaults,E=o["default"].isEmpty,R=o["default"].result,v=o["default"].every,T=o["default"].forEach,x=function(e,t){return f(e)?t:e},w=function(e){return l(e)||f(e)?String(e):h(e)||d(e)||g(e)?e.toString():JSON.stringify(e)},M=function(e){return e[u(e)[0]]},S=function(e){this.options=e||{},this.initialize(this.options)};S.prototype={initialize:function(e){},fetch:function(e,t){var n=this,r=t||{},i=void 0,o=void 0;if(d(e))o=!0,i=[e];else{if(!p(e)||E(e)||!v(e,d))throw new Error("Templates must be a string or an array of string, found: "+w(e));o=!1,i=e}var a=r.success||s,u=r.error||s,l=r.done||s,f=c(i.length,function(e){var t=void 0,n=void 0;o?(t=M(e.success),n=M(e.errors)):(t=e.success,n=e.errors),E(n)?a(t):u(n),l(t,n),a=u=l=null}),h={success:{},errors:{}};T(i,function(e){n._doFetch(e,{success:function(t){h.success[e]=t,f(h)},error:function(t){h.errors[e]=t,f(h)}})})},clear:function(){},_doFetch:function(e,t){throw new Error('Method "doFetch" should be implemented')}},S.extend=i["default"].View.extend;var N="undefined"!=typeof Map?Map:function(){var e={};return function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this._o={}}return t.prototype.has=function(t){return a(this._o,t)&&this._o[t]!==e},t.prototype.get=function(e){return this.has(e)?this._o[e]:undefined},t.prototype.set=function(e,t){this._o[e]=t},t.prototype.clear=function(){this._o={}},t.prototype["delete"]=function(t){a(this._o,t)&&(this._o[t]=e)},t}()}(),y=function(e){return'[data-template-id="'+e+'"]'},D=S.extend({initialize:function(e){this.selector=x(e.selector,y),this._cache=new N},clear:function(){this._cache.clear()},_doFetch:function(e,t){var n=this;setTimeout(function(){var r=t.success,o=t.error,s=n._cache;if(s.has(e))r(s.get(e));else{var a=n.selector(e),u=i["default"].$(a);if(E(u)||0===u.length)o({data:"Cannot find template: "+e});else if(u.length>1)o({data:"Found multiple templates for selector: "+a});else{var c=function(e){return e&&d(e)?String.prototype.trim?String.prototype.trim.call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""):e}(u.html());s.set(e,c),r(c)}}})}}),F=S.extend({initialize:function(e){var t=this;this._prefix=x(R(e,"prefix"),"/templates/"),this._suffix=x(R(e,"suffix"),".template.html"),this._method=e.method||"GET",this._cache=new N;var n=e.JST;if(n){var r=void 0;if(d(n))r=window[n];else if(g(n))r=window.JST;else{if(!m(n)||p(n))throw new Error("Cannot infer JST variables from: "+w(n));r=n}T(u(r||{}),function(e){t._cache.set(e,r[e])})}},clear:function(){this._cache.clear()},_doFetch:function(e,t){var n=t.success,r=t.error,o=this._cache;if(!o.has(e)){var s=this._prefix||"",a=this._suffix||"",u=this._method,c=function(e,t,n){var r=e.charAt(0),i=e.length>1?e.charAt(e.length-1):"",o=t.charAt(t.length-1),s=n.charAt(0),a=e;return"/"===r&&"/"===o?a=e.slice(1):"/"!==r&&"/"!==o&&(a="/"+e),"/"===i&&"/"===s&&(a=a.slice(0,a.length-1)),""+t+a+n}(e,s,a);o.set(e,i["default"].ajax({url:c,method:u}))}var l=o.get(e);if(d(l))setTimeout(function(){n(l)});else{o.get(e).then(function(t){o.set(e,t),n(t)},function(t){o["delete"](e),r({status:t.status,message:t.responseText})})}}}),V=function(e){return o["default"].template(e)},b=function(e){return V(e)},O=new F,I=function(){return O},A={templates:function(){return null},templateManager:function(){return I()},compile:function(e){return b(e)},toJSON:function(e){var t={},n=_(e||{},{view:!0});return this.model&&(t.model=this.model.toJSON(n)),this.collection&&(t.collection=this.collection.toJSON(n)),t},onBeforeRender:function(){},onRender:function(){},onRenderError:function(){},onRendered:function(e){},fetchTemplates:function(e){this._doFetchTemplates(e)},renderTemplates:function(){var e=this,t=R(this,"templates"),n={success:function(n){n&&e._renderTemplates(t,n),e._triggerRenderSuccess()},error:function(t){e._triggerRenderError(t)}};this._triggerBeforeRender(),this._doFetchTemplates(n,t)},_doFetchTemplates:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:R(this,"templates"),n=e.success||s,r=e.error||s;if(E(t))n(null);else{R(this,"templateManager").fetch(t,{success:n,error:r})}},_triggerBeforeRender:function(){this.trigger("render:loading"),this.onBeforeRender()},_triggerRenderSuccess:function(){this.trigger("render:success"),this.onRender(),this._triggerRenderDone()},_triggerRenderError:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.trigger("render:error",e),this.onRenderError(),this._triggerRenderDone(e)},_triggerRenderDone:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.trigger("render:done",e),this.onRendered(e)},_renderTemplates:function(e,t){var n=p(e),r=n?t[e[0]]:t,i=n?t:null,o=this._toHTML(r,i);return this._setHtml(o),this},_toHTML:function(e,t){return this.compile(e)(this.toJSON(),t)},_setHtml:function(e){return this.$el.html(e),this}},C=i["default"].View.extend(A).extend({render:function(){return this.renderTemplates(),this}});e.DomTemplateManager=D,e.RemoteTemplateManager=F,e.compile=b,e.overrideCompile=function(e){V=e},e.templateManager=I,e.overrideTemplateManager=function(e){O.clear(),O=e},e.TemplateViewMixin=A,e.TemplateView=C,e.VIEW_RENDER_LOADING="render:loading",e.VIEW_RENDER_SUCCESS="render:success",e.VIEW_RENDER_ERROR="render:error",e.VIEW_RENDER_DONE="render:done"});