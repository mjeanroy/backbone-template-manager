!function(e,t){if("function"==typeof define&&define.amd)define("BackboneTemplateManager",["exports","backbone","underscore"],t);else if("undefined"!=typeof exports)t(exports,require("backbone"),require("underscore"));else{var n={exports:{}};t(n.exports,e.Backbone,e._),e.BackboneTemplateManager=n.exports}}(this,function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0,e.VIEW_RENDER_DONE=e.VIEW_RENDER_ERROR=e.VIEW_RENDER_SUCCESS=e.VIEW_RENDER_LOADING=e.TemplateView=e.TemplateViewMixin=e.overrideTemplateManager=e.templateManager=e.overrideCompile=e.compile=e.RemoteTemplateManager=e.DomTemplateManager=undefined;var o=r(t),s=r(n),a=s["default"].noop,u=s["default"].has,c=s["default"].keys,l=s["default"].after,f=s["default"].isNull,d=s["default"].isUndefined,h=s["default"].isString,p=s["default"].isNumber,m=s["default"].isArray,g=s["default"].isObject,_=s["default"].isBoolean,E=s["default"].defaults,R=s["default"].isEmpty,v=s["default"].result,T=s["default"].every,x=s["default"].forEach,w=function(e,t){return d(e)?t:e},M=function(e){return e&&h(e)?String.prototype.trim?String.prototype.trim.call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""):e},S=function(e){return f(e)||d(e)?String(e):p(e)||h(e)||_(e)?e.toString():JSON.stringify(e)},N=function(e){return e[c(e)[0]]},y=function(e){this.options=e||{},this.initialize(this.options)};y.prototype={initialize:function(e){},fetch:function(e,t){var n=this,r=t||{},i=void 0,o=void 0;if(h(e))o=!0,i=[e];else{if(!m(e)||R(e)||!T(e,h))throw new Error("Templates must be a string or an array of string, found: "+S(e));o=!1,i=e}var s=r.success||a,u=r.error||a,c=r.done||a,f=l(i.length,function(e){var t=void 0,n=void 0;o?(t=N(e.success),n=N(e.errors)):(t=e.success,n=e.errors),R(n)?s(t):u(n),c(t,n),s=u=c=null}),d={success:{},errors:{}};x(i,function(e){n._doFetch(e,{success:function(t){d.success[e]=t,f(d)},error:function(t){d.errors[e]=t,f(d)}})})},clear:function(){},_doFetch:function(e,t){throw new Error('Method "doFetch" should be implemented')}},y.extend=o["default"].View.extend;var D="undefined"!=typeof Map?Map:function(){var e={};return function(){function t(){i(this,t),this._o={}}return t.prototype.has=function(t){return u(this._o,t)&&this._o[t]!==e},t.prototype.get=function(e){return this.has(e)?this._o[e]:undefined},t.prototype.set=function(e,t){this._o[e]=t},t.prototype.clear=function(){this._o={}},t.prototype["delete"]=function(t){u(this._o,t)&&(this._o[t]=e)},t}()}(),F=function(e){return'[data-template-id="'+e+'"]'},V=y.extend({initialize:function(e){this.selector=w(e.selector,F),this._cache=new D},clear:function(){this._cache.clear()},_doFetch:function(e,t){var n=this;setTimeout(function(){var r=t.success,i=t.error,s=n._cache;if(s.has(e))r(s.get(e));else{var a=n.selector(e),u=o["default"].$(a);if(R(u)||0===u.length)i({data:"Cannot find template: "+e});else if(u.length>1)i({data:"Found multiple templates for selector: "+a});else{var c=M(u.html());s.set(e,c),r(c)}}})}}),b=function(e,t,n){var r=e.charAt(0),i=e.length>1?e.charAt(e.length-1):"",o=t.charAt(t.length-1),s=n.charAt(0),a=e;return"/"===r&&"/"===o?a=e.slice(1):"/"!==r&&"/"!==o&&(a="/"+e),"/"===i&&"/"===s&&(a=a.slice(0,a.length-1)),""+t+a+n},O=y.extend({initialize:function(e){var t=this;this._prefix=w(v(e,"prefix"),"/templates/"),this._suffix=w(v(e,"suffix"),".template.html"),this._method=e.method||"GET",this._cache=new D;var n=e.JST;if(n){var r=void 0;if(h(n))r=window[n];else if(_(n))r=window.JST;else{if(!g(n)||m(n))throw new Error("Cannot infer JST variables from: "+S(n));r=n}x(c(r||{}),function(e){t._cache.set(e,r[e])})}},clear:function(){this._cache.clear()},_doFetch:function(e,t){var n=t.success,r=t.error,i=this._cache;if(!i.has(e)){var s=this._prefix||"",a=this._suffix||"",u=this._method,c=b(e,s,a);i.set(e,o["default"].ajax({url:c,method:u}))}var l=i.get(e);if(h(l))setTimeout(function(){n(l)});else{i.get(e).then(function(t){i.set(e,t),n(t)},function(t){i["delete"](e),r({status:t.status,message:t.responseText})})}}}),I=function(e){return s["default"].template(e)},A=function(e){return I(e)},C=new O,B=function(){return C},J={templates:function(){return null},templateManager:function(){return B()},compile:function(e){return A(e)},toJSON:function(e){var t={},n=E(e||{},{view:!0});return this.model&&(t.model=this.model.toJSON(n)),this.collection&&(t.collection=this.collection.toJSON(n)),t},onBeforeRender:function(){},onRender:function(){},onRenderError:function(){},onRendered:function(e){},fetchTemplates:function(e){this._doFetchTemplates(e)},renderTemplates:function(){var e=this,t=v(this,"templates"),n={success:function(n){n&&e._renderTemplates(t,n),e._triggerRenderSuccess()},error:function(t){e._triggerRenderError(t)}};this._triggerBeforeRender(),this._doFetchTemplates(n,t)},_doFetchTemplates:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:v(this,"templates"),n=e.success||a,r=e.error||a;R(t)?n(null):v(this,"templateManager").fetch(t,{success:n,error:r})},_triggerBeforeRender:function(){this.trigger("render:loading"),this.onBeforeRender()},_triggerRenderSuccess:function(){this.trigger("render:success"),this.onRender(),this._triggerRenderDone()},_triggerRenderError:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.trigger("render:error",e),this.onRenderError(),this._triggerRenderDone(e)},_triggerRenderDone:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.trigger("render:done",e),this.onRendered(e)},_renderTemplates:function(e,t){var n=m(e)?t[0]:t,r=m(t)?t:null,i=this._toHTML(n,r);return this._setHtml(i),this},_toHTML:function(e,t){return this.compile(e)(this.toJSON(),t)},_setHtml:function(e){return this.$el.html(e),this}},W=o["default"].View.extend(J).extend({render:function(){return this.renderTemplates(),this}});e.DomTemplateManager=V,e.RemoteTemplateManager=O,e.compile=A,e.overrideCompile=function(e){I=e},e.templateManager=B,e.overrideTemplateManager=function(e){C.clear(),C=e},e.TemplateViewMixin=J,e.TemplateView=W,e.VIEW_RENDER_LOADING="render:loading",e.VIEW_RENDER_SUCCESS="render:success",e.VIEW_RENDER_ERROR="render:error",e.VIEW_RENDER_DONE="render:done"});