!function(e,t){if("function"==typeof define&&define.amd)define("BackboneTemplateManager",["exports","backbone","underscore"],t);else if("undefined"!=typeof exports)t(exports,require("backbone"),require("underscore"));else{var r={exports:{}};t(r.exports,e.Backbone,e._),e.BackboneTemplateManager=r.exports}}(this,function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{"default":e}}e.__esModule=!0,e.TemplateView=e.overrideTemplateManager=e.templateManager=e.overrideCompile=e.compile=e.RemoteTemplateManager=e.DomTemplateManager=void 0;var i=n(t),o=n(r),a=o["default"].noop,s=o["default"].has,u=o["default"].keys,c=o["default"].after,l=o["default"].isNull,f=o["default"].isUndefined,d=o["default"].isString,h=o["default"].isNumber,m=o["default"].isArray,p=o["default"].isObject,g=o["default"].isBoolean,v=o["default"].defaults,_=o["default"].isEmpty,T=o["default"].result,x=o["default"].every,M=o["default"].forEach,w=o["default"].clone,S=function(e,t){return f(e)?t:e},b=function(e){return e&&d(e)?String.prototype.trim?String.prototype.trim.call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""):e},F=function(e){return l(e)||f(e)?String(e):h(e)||d(e)||g(e)?e.toString():JSON.stringify(e)},y=function(e){return e[u(e)[0]]},E=function(e){this.options=e||{},this.initialize(this.options)};E.prototype={initialize:function(e){},fetch:function(e,t){var r=this,n=t||{},i=void 0,o=void 0;if(d(e))o=!0,i=[e];else{if(!m(e)||_(e)||!x(e,d))throw new Error("Templates must be a string or an array of string, found: "+F(e));o=!1,i=e}var s=n.success||a,u=n.error||a,l=n.done||a,f=c(i.length,function(e){var t=void 0,r=void 0;o?(t=y(e.success),r=y(e.errors)):(t=e.success,r=e.errors),_(r)?s(t):u(r),l(t,r),s=u=l=null}),h={success:{},errors:{}};M(i,function(e){r._doFetch(e,{success:function(t){h.success[e]=t,f(h)},error:function(t){h.errors[e]=t,f(h)}})})},clear:function(){},_doFetch:function(e,t){throw new Error('Method "doFetch" should be implemented')}},E.extend=i["default"].View.extend;var J=function(e){return'[data-template-id="'+e+'"]'},A=E.extend({initialize:function(e){this.selector=S(e.selector,J),this._cache={}},clear:function(){this._cache={}},_doFetch:function(e,t){var r=this;setTimeout(function(){var n=t.success,o=t.error,a=r._cache;if(s(a,e))return void n(a[e]);var u=r.selector(e),c=i["default"].$(u);_(c)||0===c.length?o({data:"Cannot find template: "+e}):c.length>1?o({data:"Found multiple templates for selector: "+u}):(a[e]=b(c.html()),n(a[e]))})}}),N="/",k="/templates/",O=".template.html",z=function(e,t,r){var n=e.charAt(0),i=e.length>1?e.charAt(e.length-1):"",o=t.charAt(t.length-1),a=r.charAt(0),s=e;return n===N&&o===N?s=e.slice(1):n!==N&&o!==N&&(s="/"+e),i===N&&a===N&&(s=s.slice(0,s.length-1)),""+t+s+r},B=E.extend({initialize:function(e){this._prefix=S(T(e,"prefix"),k),this._suffix=S(T(e,"suffix"),O),this._method=e.method||"GET",this._cache={};var t=e.JST;if(t)if(d(t))this._cache=w(window[t]||{});else if(g(t))this._cache=w(window.JST||{});else{if(!p(t)||m(t))throw new Error("Cannot infer JST variables from: "+F(t));this._cache=w(t)}},clear:function(){this._cache={}},_doFetch:function(e,t){var r=t.success,n=t.error,o=this._cache;if(!s(o,e)||l(o[e])){var a=this._prefix||"",u=this._suffix||"",c=this._method,f=z(e,a,u);o[e]=i["default"].ajax({url:f,method:c})}var h=o[e];if(d(h))return void setTimeout(function(){r(h)});var m=function(t){o[e]=t,r(t)},p=function(t){o[e]=null,n({status:t.status,message:t.responseText})};o[e].then(m,p)}}),C=function(e){return o["default"].template(e)},H=function(e){return C(e)},V=function(e){C=e},$=new B,j=function(){return $},q=function(e){$.clear(),$=e},D="render",L=i["default"].View.extend({templates:function(){return null},templateManager:function(){return j()},compile:function(e){return H(e)},toJSON:function(e){var t={},r=v(e||{},{view:!0});return this.model&&(t.model=this.model.toJSON(r)),this.collection&&(t.collection=this.collection.toJSON(r)),t},render:function(){var e=this,t=T(this,"templates");if(!_(t)){this.trigger(D+":loading");var r=T(this,"templateManager");return r.fetch(t,{success:function(r){e._renderTemplates(t,r),e.trigger(D+":success")},error:function(){e.trigger(D+":error")}}),this}},_renderTemplates:function(e,t){var r=m(e)?t[0]:t,n=m(t)?t:null,i=this._toHTML(r,n);return this._setHtml(i),this},_toHTML:function(e,t){var r=this.compile(e);return r(this.toJSON(),t)},_setHtml:function(e){return this.$el.html(e),this}});e.DomTemplateManager=A,e.RemoteTemplateManager=B,e.compile=H,e.overrideCompile=V,e.templateManager=j,e.overrideTemplateManager=q,e.TemplateView=L});