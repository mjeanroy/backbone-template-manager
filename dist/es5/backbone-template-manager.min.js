!function(e,t){if("function"==typeof define&&define.amd)define("BackboneTemplateManager",["exports","backbone","underscore"],t);else if("undefined"!=typeof exports)t(exports,require("backbone"),require("underscore"));else{var n={exports:{}};t(n.exports,e.Backbone,e._),e.BackboneTemplateManager=n.exports}}(this,function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}e.__esModule=!0,e.TemplateView=e.overrideTemplateManager=e.templateManager=e.overrideCompile=e.compile=e.RemoteTemplateManager=e.DomTemplateManager=undefined;var i=r(t),o=r(n),a=o["default"].noop,s=o["default"].has,u=o["default"].keys,c=o["default"].after,l=o["default"].isNull,f=o["default"].isUndefined,d=o["default"].isString,h=o["default"].isNumber,m=o["default"].isArray,p=o["default"].isObject,g=o["default"].isBoolean,v=o["default"].defaults,_=o["default"].isEmpty,T=o["default"].result,x=o["default"].every,M=o["default"].forEach,w=o["default"].clone,S=function(e,t){return f(e)?t:e},b=function(e){return e&&d(e)?String.prototype.trim?String.prototype.trim.call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""):e},F=function(e){return l(e)||f(e)?String(e):h(e)||d(e)||g(e)?e.toString():JSON.stringify(e)},y=function(e){return e[u(e)[0]]},R=function(e){this.options=e||{},this.initialize(this.options)};R.prototype={initialize:function(e){},fetch:function(e,t){var n=this,r=t||{},i=void 0,o=void 0;if(d(e))o=!0,i=[e];else{if(!m(e)||_(e)||!x(e,d))throw new Error("Templates must be a string or an array of string, found: "+F(e));o=!1,i=e}var s=r.success||a,u=r.error||a,l=r.done||a,f=c(i.length,function(e){var t=void 0,n=void 0;o?(t=y(e.success),n=y(e.errors)):(t=e.success,n=e.errors),_(n)?s(t):u(n),l(t,n),s=u=l=null}),h={success:{},errors:{}};M(i,function(e){n._doFetch(e,{success:function(t){h.success[e]=t,f(h)},error:function(t){h.errors[e]=t,f(h)}})})},clear:function(){},_doFetch:function(e,t){throw new Error('Method "doFetch" should be implemented')}},R.extend=i["default"].View.extend;var E=function(e){return'[data-template-id="'+e+'"]'},J=R.extend({initialize:function(e){this.selector=S(e.selector,E),this._cache={}},clear:function(){this._cache={}},_doFetch:function(e,t){var n=this;setTimeout(function(){var r=t.success,o=t.error,a=n._cache;if(s(a,e))return void r(a[e]);var u=n.selector(e),c=i["default"].$(u);_(c)||0===c.length?o({data:"Cannot find template: "+e}):c.length>1?o({data:"Found multiple templates for selector: "+u}):(a[e]=b(c.html()),r(a[e]))})}}),A=function(e,t,n){var r=e.charAt(0),i=e.length>1?e.charAt(e.length-1):"",o=t.charAt(t.length-1),a=n.charAt(0),s=e;return"/"===r&&"/"===o?s=e.slice(1):"/"!==r&&"/"!==o&&(s="/"+e),"/"===i&&"/"===a&&(s=s.slice(0,s.length-1)),""+t+s+n},N=R.extend({initialize:function(e){this._prefix=S(T(e,"prefix"),"/templates/"),this._suffix=S(T(e,"suffix"),".template.html"),this._method=e.method||"GET",this._cache={};var t=e.JST;if(t)if(d(t))this._cache=w(window[t]||{});else if(g(t))this._cache=w(window.JST||{});else{if(!p(t)||m(t))throw new Error("Cannot infer JST variables from: "+F(t));this._cache=w(t)}},clear:function(){this._cache={}},_doFetch:function(e,t){var n=t.success,r=t.error,o=this._cache;if(!s(o,e)||l(o[e])){var a=this._prefix||"",u=this._suffix||"",c=this._method,f=A(e,a,u);o[e]=i["default"].ajax({url:f,method:c})}var h=o[e];if(d(h))return void setTimeout(function(){n(h)});var m=function(t){o[e]=t,n(t)},p=function(t){o[e]=null,r({status:t.status,message:t.responseText})};o[e].then(m,p)}}),k=function(e){return o["default"].template(e)},B=function(e){return k(e)},O=function(e){k=e},z=new N,C=function(){return z},H=function(e){z.clear(),z=e},V=i["default"].View.extend({templates:function(){return null},templateManager:function(){return C()},compile:function(e){return B(e)},toJSON:function(e){var t={},n=v(e||{},{view:!0});return this.model&&(t.model=this.model.toJSON(n)),this.collection&&(t.collection=this.collection.toJSON(n)),t},render:function(){var e=this,t=T(this,"templates");if(!_(t)){this.trigger("render:loading"),this.onBeforeRender();return T(this,"templateManager").fetch(t,{success:function(n){e._renderTemplates(t,n),e.trigger("render:success"),e.onRender(),e.onRendered()},error:function(t){e.trigger("render:error"),e.onRenderError(),e.onRendered(t)}}),this}},onBeforeRender:function(){},onRender:function(){},onRenderError:function(){},onRendered:function(e){},_renderTemplates:function(e,t){var n=m(e)?t[0]:t,r=m(t)?t:null,i=this._toHTML(n,r);return this._setHtml(i),this},_toHTML:function(e,t){return this.compile(e)(this.toJSON(),t)},_setHtml:function(e){return this.$el.html(e),this}});e.DomTemplateManager=J,e.RemoteTemplateManager=N,e.compile=B,e.overrideCompile=O,e.templateManager=C,e.overrideTemplateManager=H,e.TemplateView=V});